name: CI/CD

on:
  push:
    branches:
      - develop
      - master

jobs:
  # Job para construir y probar el backend
  backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Paso para configurar Docker
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Paso para autenticar con GCR
      - name: Set up Google Cloud authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS }}

      # Paso para configurar la imagen Docker del backend
      - name: Build backend Docker image
        run: |
          docker build -t gcr.io/${{ secrets.GCP_PROJECT_ID }}/backend-api:v1 ./backend
          docker push gcr.io/${{ secrets.GCP_PROJECT_ID }}/backend-api:v1

      # Paso para ejecutar pruebas del backend
      - name: Run backend tests
        run: |
          docker run --rm gcr.io/${{ secrets.GCP_PROJECT_ID }}/backend-api:v1 npm test

      - name: Deploy to GKE
        uses: google-github-actions/deploy-gke@v0
        with:
          cluster_name: event-api-cluster
          location: us-central1-a
          project_id: ${{ secrets.GCP_PROJECT_ID }}
          manifest: ./kubernetes/backend-deployment.yaml

  # Job para construir y probar el frontend
  frontend:
    runs-on: ubuntu-latest
    needs: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Paso para configurar Docker
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Paso para autenticar con GCR
      - name: Set up Google Cloud authentication
        uses: google-github-actions/auth@v2
        with:
          credentials_json:
